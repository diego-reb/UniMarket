<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard de Vendedor – UniMarket</title>
    <meta name="description" content="Gestiona tus productos y pedidos en UniMarket." />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a;
            --card: #111827;
            --muted: #94a3b8;
            --text: #e5e7eb;
            --brand: #22c55e;
            --brand-2: #38bdf8;
            --accent: #fde047;
            --error: #ef4444;
            --ok: #10b981;
            --shadow: 0 10px 30px rgba(0, 0, 0, .35);
            --radius: 16px;
        }
        * { box-sizing: border-box }
        html, body { height: 100% }
        body {
            margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
            background: radial-gradient(1200px 600px at 10% -10%, rgba(56,189,248,.25), rgba(56,189,248,0)),
                        radial-gradient(900px 600px at 120% 10%, rgba(34,197,94,.20), rgba(34,197,94,0)),
                        var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
        }
        a { color: inherit; text-decoration: none }
        .container { max-width: 1200px; margin: auto; padding: 20px }
        header { position: sticky; top: 0; z-index: 50; backdrop-filter: blur(10px);
                 background: linear-gradient(180deg, rgba(15,23,42,.85), rgba(15,23,42,.65));
                 border-bottom: 1px solid rgba(148,163,184,.15); }
        .header-wrap { display: flex; align-items: center; gap: 16px; padding: 14px 20px }
        .logo { display: flex; align-items: center; gap: 10px; font-weight: 800; letter-spacing: .2px }
        .logo-badge { width: 42px; height: 42px; border-radius: 12px; display: grid; place-items: center;
                      background: linear-gradient(135deg, var(--brand), var(--brand-2));
                      box-shadow: var(--shadow); }
        .brand { font-size: 1.35rem }
        .tagline { font-size: .9rem; color: var(--muted) }
        .actions { margin-left: auto; }
        .icon-btn { width: 42px; height: 42px; border-radius: 12px; display: grid; place-items: center; border: 1px solid rgba(148,163,184,.25);
                    background: rgba(2,6,23,.6); cursor: pointer; transition: transform .06s ease, border .2s; }
        .icon-btn:hover { border-color: var(--brand-2) }
        .icon-btn:active { transform: translateY(1px) }
        main { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .card { background: rgba(2,6,23,.55); border: 1px solid rgba(148,163,184,.20); border-radius: var(--radius);
                box-shadow: var(--shadow); padding: 32px; width: 100%; max-width: 900px; margin-bottom: 20px; }
        .card h1 { font-size: 2rem; margin: 0 0 8px; text-align: center; }
        .card p { margin: 0 0 24px; color: var(--muted); text-align: center; }
        .form-group { margin-bottom: 24px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(148,163,184,.25);
                                   background: rgba(2,6,23,.6); color: var(--text); outline: none; transition: border .2s ease; }
        input:focus, select:focus, textarea:focus { border-color: var(--brand-2); }
        .flex-row { display: flex; gap: 20px; }
        .flex-row > div { flex: 1; }
        .btn-group { display: flex; justify-content: center; flex-wrap: wrap; gap: 16px; margin-bottom: 30px; }
        .btn { padding: 12px 24px; border: none; border-radius: 12px; background: rgba(148,163,184,.1); color: var(--text); font-weight: 600; cursor: pointer; transition: background .2s, transform .06s; }
        .btn:hover { background: rgba(148,163,184,.2); }
        .btn.active { background: var(--brand-2); color: white; }
        .btn-primary { background: linear-gradient(135deg, var(--brand), var(--brand-2)); color: white; font-weight: 800; border: none; }
        .btn-primary:hover { filter: brightness(1.05); }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .product-list, .order-list { display: grid; gap: 20px; }
        .product-item, .order-item { padding: 16px; background: rgba(148,163,184,.05); border-radius: 12px; border: 1px solid rgba(148,163,184,.1); display: flex; align-items: center; gap: 20px; }
        .product-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; background: var(--card); }
        .product-details { flex: 1; }
        .product-details h3 { margin: 0 0 4px; font-size: 1.2rem; }
        .product-details p { margin: 0; color: var(--muted); font-size: 0.9rem; }
        .product-actions { display: flex; gap: 10px; }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .order-header h3 { margin: 0; font-size: 1.1rem; }
        .order-status.pending { color: var(--accent); font-weight: bold; }
        .order-status.completed { color: var(--ok); font-weight: bold; }
        .order-details p { margin: 0 0 8px; font-size: 0.95rem; }
        footer { padding: 20px; color: var(--muted); text-align: center; }
    </style>
</head>
<body>
<header>
    <div class="header-wrap container">
        <a class="logo" href="/vendedor">
            <div class="logo-badge"></div>
            <div>
                <div class="brand">UniMarket</div>
                <div class="tagline">Dashboard de Vendedor</div>
            </div>
        </a>
        <div class="actions">
            <a href="{{ url_for('logout') }}" class="icon-btn" title="Cerrar sesión" aria-label="Cerrar sesión">Salir</a>
        </div>
    </div>
</header>

<main>
<div class="card">
    <h1>Bienvenid@, {{ current_user.nombre }}</h1>
    <p>Gestiona tus productos y pedidos desde tu panel de control.</p>

    <!-- Menú del dashboard -->
    <div class="btn-group">
        <button class="btn active" onclick="showSection('add-product', this)">Agregar productos</button>
        <button class="btn" onclick="showSection('product-list', this)">Lista de productos</button>
        <button class="btn" onclick="showSection('orders', this)">Pedidos</button>
        <button class="btn" onclick="showSection('order-history', this)">Historial</button>
    </div>

    <!-- Agregar producto -->
    <div id="add-product" class="content-section active">
        <h2 style="text-align:center;margin-bottom:24px;">Agregar Nuevo Producto</h2>
        <form action="{{ url_for('crear_producto') }}" method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label for="product-name">Nombre del producto</label>
                <input type="text" name="nombre" id="product-name" required placeholder="Ej. Libro de cálculo">
            </div>
            <div class="form-group">
                <label for="product-description">Descripción</label>
                <textarea name="descripcion" id="product-description" rows="4" required placeholder="Describe tu producto."></textarea>
            </div>
            <div class="flex-row">
                <div class="form-group">
                    <label for="product-quantity">Cantidad disponible</label>
                    <input type="number" name="stock" id="product-quantity" min="1" required value="1">
                </div>
                <div class="form-group">
                    <label for="product-cost">Costo ($)</label>
                    <input type="number" name="precio" id="product-cost" min="0" step="0.01" required value="0.00">
                </div>
            </div>
            <div class="form-group">
                <label for="product-image">Imagen del producto</label>
                <input type="file" name="foto" id="product-image" accept="image/*" class="btn">
            </div>
            <div class="form-group">
                <label for="product-category">Categoría</label>
                <select name="id_categoria" id="product-category" required>
                    <option value="" disabled selected>Selecciona una categoría</option>
                    {% for cat in categorias %}
                        <option value="{{ cat.id_categoria }}">{{ cat.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn-primary" style="margin-top:20px;">Guardar Producto</button>
        </form>
    </div>

    <!-- Lista de productos -->
    <div id="product-list" class="content-section">
        <h2 style="text-align:center;margin-bottom:24px;">Mis Productos</h2>
        <div class="product-list">
            {% if productos %}
                {% for p in productos %}
                {% if not p.entregado %}
                <div class="product-item" id="producto-{{ p.id_producto }}">
                   <img src="{{ url_for('static', filename='uploads/' ~ p.foto) }}" alt="{{ p.nombre }}">

                    <div class="product-details">
                        <h3>{{ p.nombre }}</h3>
                        <p>{{ p.descripcion }}</p>
                        <p>Cantidad: {{ p.stock }} • ${{ "%.2f"|format(p.precio) }}</p>
                    </div>

                    <div class="product-actions">
                        <button class="btn" onclick="editarProducto({{ p.id_producto }})">Editar</button>
                        <button class="btn" onclick="eliminarProducto({{ p.id_producto }})">Eliminar</button>
                        
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            {% else %}
                <p style="text-align:center;color:var(--muted)">No hay productos registrados.</p>
            {% endif %}
        </div>
    </div>

 <!-- Pedidos pendientes -->
<div id="orders" class="content-section">
    <h2 style="text-align:center;margin-bottom:24px;">Pedidos Pendientes</h2>
    <div class="product-list">
        {% if pedidos %}
            {% for pedido in pedidos %}
                {% if pedido.estado|lower == 'pendiente' %}
                <div class="product-item" id="pedido-{{ pedido.id_pedido }}">
                    <div class="product-details">
                        <h3>Pedido #{{ pedido.id_pedido }}</h3>
                        <p><strong>Comprador:</strong> {{ pedido.comprador_nombre }} ({{ pedido.comprador_correo }})</p>
                        <p><strong>Fecha:</strong> {{ pedido.fecha.strftime('%d/%m/%Y %H:%M') }}</p>
                        <p><strong>Productos:</strong> {{ pedido.productos|join(', ') }}</p>
                        <p><strong>Total:</strong> ${{ "%.2f"|format(pedido.total) }}</p>
                        <p><strong>Teléfono:</strong> {{ pedido.comprador_telefono or "No disponible" }}</p>


                    </div>
                    <div class="product-actions">
                        <button class="btn btn-primary" onclick="marcarPedidoEntregado({{ pedido.id_pedido }})">
                            Marcar como Entregado
                        </button>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <p style="text-align:center;color:var(--muted)">No hay pedidos pendientes.</p>
        {% endif %}
    </div>
</div>

   <div id="order-history" class="content-section">
    <h2 style="text-align:center;margin-bottom:24px;">Historial de Productos Entregados</h2>
    <div class="product-list">
        {% if historial %}
            {% for pedido in historial %}
            <div class="product-item">
                <div class="product-details">
                    <h3>Pedido #{{ pedido.id_pedido }}</h3>
                    <p><strong>Comprador:</strong> {{ pedido.comprador_nombre }} ({{ pedido.comprador_correo }})</p>
                    <p><strong>Teléfono:</strong> {{ pedido.comprador_telefono or "No disponible" }}</p>
                    <p><strong>Fecha:</strong> {{ pedido.fecha.strftime('%d/%m/%Y %H:%M') }}</p>
                    <p><strong>Productos:</strong> {{ pedido.productos|join(', ') }}</p>
                    <p><strong>Total:</strong> ${{ "%.2f"|format(pedido.total) }}</p>
                    <span class="order-status completed">Entregado</span>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p style="text-align:center;color:var(--muted)">No hay productos entregados.</p>
        {% endif %}
    </div>
</div>


</div>
</main>

<footer>
    <div class="container">© <span id="year"></span> UniMarket • Hecho por estudiantes para estudiantes.</div>
</footer>

<!-- Modal para editar producto -->
<div id="editModal" style="
    display:none; position:fixed; inset:0; background:rgba(0,0,0,.5);
    align-items:center; justify-content:center; z-index:1000;">
    <div style="
        background:rgba(2,6,23,.95); padding:24px; border-radius:16px; width:90%; max-width:500px;">
        <h2 style="margin-top:0;">Editar producto</h2>
        <form id="editForm" enctype="multipart/form-data">
            <input type="hidden" name="id" id="edit-id">
            <div class="form-group">
                <label for="edit-nombre">Nombre</label>
                <input type="text" name="nombre" id="edit-nombre" required>
            </div>
            <div class="form-group">
                <label for="edit-descripcion">Descripción</label>
                <textarea name="descripcion" id="edit-descripcion" rows="3" required></textarea>
            </div>
            <div class="flex-row">
                <div class="form-group">
                    <label for="edit-stock">Cantidad</label>
                    <input type="number" name="stock" id="edit-stock" min="1" required>
                </div>
                <div class="form-group">
                    <label for="edit-precio">Precio</label>
                    <input type="number" name="precio" id="edit-precio" step="0.01" required>
                </div>
            </div>
            <div class="form-group">
                <label for="edit-foto">Nueva imagen (opcional)</label>
                <input type="file" name="foto" id="edit-foto" accept="image/*">
            </div>
            <div class="form-group">
                <label for="edit-categoria">Categoría</label>
                <select name="id_categoria" id="edit-categoria" required>
                    {% for cat in categorias %}
                        <option value="{{ cat.id_categoria }}">{{ cat.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="text-align:right;">
                <button type="button" class="btn" onclick="cerrarModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar cambios</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // Cambiar de sección
    function showSection(sectionId, btn) {
        document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
        document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
    }

    // Abrir modal y cargar datos del producto
    function editarProducto(id) {
        if(!id) return alert("ID de producto inválido");
        fetch(`/producto/${id}`)
            .then(res => res.json())
            .then(p => {
                if(!p || !p.id_producto) return alert("No se pudo cargar el producto");
                document.getElementById('edit-id').value = p.id_producto;
                document.getElementById('edit-nombre').value = p.nombre;
                document.getElementById('edit-descripcion').value = p.descripcion;
                document.getElementById('edit-stock').value = p.stock;
                document.getElementById('edit-precio').value = p.precio;
                document.getElementById('edit-categoria').value = p.id_categoria;
                document.getElementById('editModal').style.display = 'flex';
            })
            .catch(err => {
                console.error(err);
                alert("Error al obtener el producto");
            });
    }

    // Cerrar modal
    function cerrarModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    // Guardar cambios del producto
    document.getElementById('editForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const id = document.getElementById('edit-id').value;
        if(!id) return alert("ID de producto inválido");

        const formData = new FormData(this);

        fetch(`/vendedor/producto/editar/${id}`, {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                alert('Producto actualizado correctamente');
                location.reload();
            } else {
                alert('Error al actualizar: ' + (data.error || ''));
            }
        })
        .catch(err => {
            console.error(err);
            alert("Error al actualizar el producto. Revisa la consola.");
        });
    });

    // Eliminar producto
    function eliminarProducto(id) {
        if(confirm("¿Estás seguro de eliminar este producto?")) {
            fetch(`/producto/eliminar/${id}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        document.getElementById(`producto-${id}`).remove();
                    } else {
                        alert("Error al eliminar el producto");
                    }
                });
        }
    }

   function marcarPedidoEntregado(id) {
    if (!confirm("Marcar este pedido como entregado?")) return;

    fetch(`/pedido/entregado/${id}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const pedidoElem = document.getElementById(`pedido-${id}`);
                if (pedidoElem) pedidoElem.remove();

                const historial = document.querySelector('#order-history .product-list');
                const pedidoHist = document.createElement('div');
                pedidoHist.classList.add('product-item');

                let productosHtml = data.pedido.productos.join(', ');

                pedidoHist.innerHTML = `
                    <div class="product-details">
                        <h3>Pedido #${data.pedido.id_pedido}</h3>
                        <p><strong>Comprador:</strong> ${data.pedido.comprador_nombre} (${data.pedido.comprador_correo})</p>
                        <p><strong>Teléfono:</strong> ${data.pedido.comprador_telefono || 'No disponible'}</p>
                        <p><strong>Fecha:</strong> ${data.pedido.fecha}</p>
                        <p><strong>Productos:</strong> ${productosHtml}</p>
                        <p><strong>Total:</strong> $${parseFloat(data.pedido.total).toFixed(2)}</p>
                        <span class="order-status completed">Entregado</span>
                    </div>
                `;

                historial.prepend(pedidoHist);

                showSection('order-history');
            } else {
                alert("Error: " + (data.error || "No se pudo marcar como entregado"));
            }
        })
        .catch(err => {
            console.error(err);
            alert("Error al actualizar el pedido. Revisa la consola.");
        });
}


</script>

</body>
</html>
