<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard de Vendedor ‚Äì UniMarket</title>
    <meta name="description" content="Gestiona tus productos y pedidos en UniMarket." />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css')}}">
    <script src="{{ url_for('static', filename='js/accesibilidad.js')}}"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card: #111827;
            --muted: #94a3b8;
            --text: #e5e7eb;
            --brand: #22c55e;
            --brand-2: #38bdf8;
            --accent: #fde047;
            --error: #ef4444;
            --ok: #10b981;
            --shadow: 0 10px 30px rgba(0, 0, 0, .35);
            --radius: 16px;
        }
        * { box-sizing: border-box }
        html, body { height: 100% }
        body {
            margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
            background: radial-gradient(1200px 600px at 10% -10%, rgba(56,189,248,.25), rgba(56,189,248,0)),
                        radial-gradient(900px 600px at 120% 10%, rgba(34,197,94,.20), rgba(34,197,94,0)),
                        var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
        }
        a { color: inherit; text-decoration: none }
        .container { max-width: 1200px; margin: auto; padding: 20px }
        header { position: sticky; top: 0; z-index: 50; backdrop-filter: blur(10px);
                 background: linear-gradient(180deg, rgba(15,23,42,.85), rgba(15,23,42,.65));
                 border-bottom: 1px solid rgba(148,163,184,.15); }
        .header-wrap { display: flex; align-items: center; gap: 16px; padding: 14px 20px }
        .logo { display: flex; align-items: center; gap: 10px; font-weight: 800; letter-spacing: .2px }
        .logo-badge { width: 42px; height: 42px; border-radius: 12px; display: grid; place-items: center;
                      background: linear-gradient(135deg, var(--brand), var(--brand-2));
                      box-shadow: var(--shadow); }
        .brand { font-size: 1.35rem }
        .tagline { font-size: .9rem; color: var(--muted) }
        .actions { margin-left: auto; display: flex; align-items: center; gap: 10px;}
        .icon-btn { width: 42px; height: 42px; border-radius: 12px; display: grid; place-items: center; border: 1px solid rgba(148,163,184,.25);
                    background: rgba(2,6,23,.6); cursor: pointer; transition: transform .06s ease, border .2s; }
        .icon-btn:hover { border-color: var(--brand-2) }
        .icon-btn:active { transform: translateY(1px) }
        main { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .card { background: rgba(2,6,23,.55); border: 1px solid rgba(148,163,184,.20); border-radius: var(--radius);
                box-shadow: var(--shadow); padding: 32px; width: 100%; max-width: 900px; margin-bottom: 20px; }
        .card h1 { font-size: 2rem; margin: 0 0 8px; text-align: center; }
        .card p { margin: 0 0 24px; color: var(--muted); text-align: center; }
        .form-group { margin-bottom: 24px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(148,163,184,.25);
                                   background: rgba(2,6,23,.6); color: var(--text); outline: none; transition: border .2s ease; }
        input:focus, select:focus, textarea:focus { border-color: var(--brand-2); }
        .flex-row { display: flex; gap: 20px; }
        .flex-row > div { flex: 1; }
        .btn-group { display: flex; justify-content: center; flex-wrap: wrap; gap: 16px; margin-bottom: 30px; }
        .btn { padding: 12px 24px; border: none; border-radius: 12px; background: rgba(148,163,184,.1); color: var(--text); font-weight: 600; cursor: pointer; transition: background .2s, transform .06s; }
        .btn:hover { background: rgba(148,163,184,.2); }
        .btn.active { background: var(--brand-2); color: white; }
        .btn-primary { background: linear-gradient(135deg, var(--brand), var(--brand-2)); color: white; font-weight: 800; border: none; }
        .btn-primary:hover { filter: brightness(1.05); }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .product-list, .order-list { display: grid; gap: 20px; }
        .product-item, .order-item { padding: 16px; background: rgba(148,163,184,.05); border-radius: 12px; border: 1px solid rgba(148,163,184,.1); display: flex; align-items: center; gap: 20px; }
        .product-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; background: var(--card); }
        .product-details { flex: 1; }
        .product-details h3 { margin: 0 0 4px; font-size: 1.2rem; }
        .product-details p { margin: 0; color: var(--muted); font-size: 0.9rem; }
        .product-actions { display: flex; gap: 10px; }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .order-header h3 { margin: 0; font-size: 1.1rem; }
        .order-status.pending { color: var(--accent); font-weight: bold; }
        .order-status.completed { color: var(--ok); font-weight: bold; }
        .order-details p { margin: 0 0 8px; font-size: 0.95rem; }
        .guardar-btn {
            padding: 12px 24px !important;border-radius: 12px !important;background: linear-gradient(135deg, var(--brand), var(--brand-2)) !important;color: white !important;font-weight: 800 !important;border: none !important;cursor: pointer;}

        footer { padding: 20px; color: var(--muted); text-align: center; }
        
        /* Estilos para el Modal del Chatbot (A√±adido del index.html) */
        .chat-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none; /* Inicialmente oculto */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .chat-modal-content {
            background: var(--card);
            border-radius: var(--radius);
            width: 350px;
            height: 450px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(90deg, var(--brand), var(--brand-2));
            padding: 15px;
            color: var(--bg);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header button {
            background: none;
            border: none;
            color: var(--bg);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }

        .chat-body {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-input-area {
            padding: 10px 15px;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
            display: flex;
            gap: 10px;
        }

        .chat-input-area input {
            flex-grow: 1;
            padding: 10px;
            border-radius: 999px;
            border: 1px solid var(--muted);
            background: var(--bg);
            color: var(--text);
            outline: none;
        }

        .chat-input-area button {
            background: var(--brand);
            color: var(--bg);
            border: none;
            border-radius: 999px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .chat-input-area button:hover {
            background: var(--ok);
        }

        /* Estilos de mensajes */
        .message {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 12px;
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--brand-2); /* Sky Blue */
            color: var(--bg);
        }

        .bot-message {
            align-self: flex-start;
            background-color: var(--card);
            border: 1px solid rgba(148, 163, 184, 0.15);
        }

        .bot-message::before {
            content: 'ü§ñ ';
        }
    </style>
</head>
<body>
    <div class="reading-guide" id="reading-guide-mask"></div>
<header>
    <div class="header-wrap container">
        <a class="logo" href="/vendedor">
            <div class="logo-badge"></div>
            <div>
                <div class="brand">UniMarket</div>
                <div class="tagline">Dashboard de Vendedor</div>
            </div>
        </a>
        <div class="actions">
             <button class="icon-btn" id="botBtn" title="Asistente de Vendedor" aria-label="Abrir Asistente de Chat">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#38bdf8;">
                    <path d="M12 2v2"></path>
                    <path d="M10 18h4"></path>
                    <path d="M10 5a2 2 0 0 1 4 0v3a2 2 0 0 1-4 0v-3z"></path>
                    <path d="M19 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2z"></path>
                    <line x1="15" y1="9" x2="15" y2="9"></line>
                    <line x1="9" y1="9" x2="9" y2="9"></line>
                </svg>
            </button>
            
            <a href="{{ url_for('logout') }}" class="icon-btn" title="Cerrar sesi√≥n" aria-label="Cerrar sesi√≥n">
                 <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
            </a>
        </div>
    </div>
</header>

<main>
<div class="card">
    <h1>Bienvenid@, {{ current_user.nombre }}</h1>
    <p>Gestiona tus productos y pedidos desde tu panel de control.</p>

    <div class="btn-group">
        <button class="btn active" onclick="showSection('add-product', this)">Agregar productos</button>
        <button class="btn" onclick="showSection('product-list', this)">Lista de productos</button>
        <button class="btn" onclick="showSection('orders', this)">Pedidos</button>
        <button class="btn" onclick="showSection('order-history', this)">Historial</button>
    </div>

    <div id="add-product" class="content-section active">
        <h2 style="text-align:center;margin-bottom:24px;">Agregar Nuevo Producto</h2>
        <form action="{{ url_for('crear_producto') }}" method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label for="product-name">Nombre del producto</label>
                <input type="text" name="nombre" id="product-name" required placeholder="Ej. Libro de c√°lculo">
            </div>
            <div class="form-group">
                <label for="product-description">Descripci√≥n</label>
                <textarea name="descripcion" id="product-description" rows="4" required placeholder="Describe tu producto."></textarea>
            </div>
            <div class="flex-row">
                <div class="form-group">
                    <label for="product-quantity">Cantidad disponible</label>
                    <input type="number" name="stock" id="product-quantity" min="1" required value="1">
                </div>
                <div class="form-group">
                    <label for="product-cost">Costo ($)</label>
                    <input type="number" name="precio" id="product-cost" min="0" step="0.01" required value="0.00">
                </div>
            </div>
            <div class="form-group">
                <label for="product-image">Imagen del producto</label>
                <input type="file" name="foto" id="product-image" accept="image/*" class="btn">
            </div>
            <div class="form-group">
                <label for="product-category">Categor√≠a</label>
                <select name="id_categoria" id="product-category" required>
                    <option value="" disabled selected>Selecciona una categor√≠a</option>
                    {% for cat in categorias %}
                        <option value="{{ cat.id_categoria }}">{{ cat.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top:20px;">Guardar Producto</button>
        </form>
    </div>

    <div id="product-list" class="content-section">
        <h2 style="text-align:center;margin-bottom:24px;">Mis Productos</h2>
        <div class="product-list">
            {% if productos %}
                {% for p in productos %}
                {% if not p.entregado %}
                <div class="product-item" id="producto-{{ p.id_producto }}">
                   {% if p.foto %}
                    <img src="{{ p.foto }}" alt="{{ p.nombre }}" style="max-width:100%; border-radius:8px;">
                    {% endif %}


                    <div class="product-details">
                        <h3>{{ p.nombre }}</h3>
                        <p>{{ p.descripcion }}</p>
                        <p>Cantidad: {{ p.stock }} ‚Ä¢ ${{ "%.2f"|format(p.precio) }}</p>
                    </div>

                    <div class="product-actions">
                        <button class="btn" onclick="editarProducto({{ p.id_producto }})">Editar</button>
                        <button class="btn" onclick="eliminarProducto({{ p.id_producto }})">Eliminar</button>
                        
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            {% else %}
                <p style="text-align:center;color:var(--muted)">No hay productos registrados.</p>
            {% endif %}
        </div>
    </div>

 <div id="orders" class="content-section">
    <h2 style="text-align:center;margin-bottom:24px;">Pedidos Pendientes</h2>
    <div class="product-list">
        {% if pedidos %}
            {% for pedido in pedidos %}
                {% if pedido.estado|lower == 'pendiente' %}
                <div class="product-item" id="pedido-{{ pedido.id_pedido }}">
                    <div class="product-details">
                        <h3>Pedido #{{ pedido.id_pedido }}</h3>
                        <p><strong>Comprador:</strong> {{ pedido.comprador_nombre }} ({{ pedido.comprador_correo }})</p>
                        <p><strong>Fecha:</strong> {{ pedido.fecha.strftime('%d/%m/%Y %H:%M') }}</p>
                        <p><strong>Productos:</strong> {{ pedido.productos|join(', ') }}</p>
                        <p><strong>Total:</strong> ${{ "%.2f"|format(pedido.total) }}</p>
                        <p><strong>Tel√©fono:</strong> {{ pedido.comprador_telefono or "No disponible" }}</p>


                    </div>
                    <div class="product-actions">
                        <button class="btn btn-primary" onclick="marcarPedidoEntregado({{ pedido.id_pedido }})">
                            Marcar como Entregado
                        </button>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <p style="text-align:center;color:var(--muted)">No hay pedidos pendientes.</p>
        {% endif %}
    </div>
</div>

   <div id="order-history" class="content-section">
    <h2 style="text-align:center;margin-bottom:24px;">Historial de Productos Entregados</h2>
    <div class="product-list">
        {% if historial %}
            {% for pedido in historial %}
            <div class="product-item">
                <div class="product-details">
                    <h3>Pedido #{{ pedido.id_pedido }}</h3>
                    <p><strong>Comprador:</strong> {{ pedido.comprador_nombre }} ({{ pedido.comprador_correo }})</p>
                    <p><strong>Tel√©fono:</strong> {{ pedido.comprador_telefono or "No disponible" }}</p>
                    <p><strong>Fecha:</strong> {{ pedido.fecha.strftime('%d/%m/%Y %H:%M') }}</p>
                    <p><strong>Productos:</strong> {{ pedido.productos|join(', ') }}</p>
                    <p><strong>Total:</strong> ${{ "%.2f"|format(pedido.total) }}</p>
                    <span class="order-status completed">Entregado</span>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p style="text-align:center;color:var(--muted)">No hay productos entregados.</p>
        {% endif %}
    </div>
</div>


</div>
</main>

<footer>
    <div class="container">¬© <span id="year"></span> UniMarket ‚Ä¢ Hecho por estudiantes para estudiantes.</div>
</footer>

<div id="editModal" style="
    display:none; position:fixed; inset:0; background:rgba(0,0,0,.5);
    align-items:center; justify-content:center; z-index:1000;">
    <div style="
        background:rgba(2,6,23,.95); padding:24px; border-radius:16px; width:90%; max-width:500px;">
        <h2 style="margin-top:0;">Editar producto</h2>
        <form id="editForm" enctype="multipart/form-data">
            <input type="hidden" name="id" id="edit-id">
            <div class="form-group">
                <label for="edit-nombre">Nombre</label>
                <input type="text" name="nombre" id="edit-nombre" required>
            </div>
            <div class="form-group">
                <label for="edit-descripcion">Descripci√≥n</label>
                <textarea name="descripcion" id="edit-descripcion" rows="3" required></textarea>
            </div>
            <div class="flex-row">
                <div class="form-group">
                    <label for="edit-stock">Cantidad</label>
                    <input type="number" name="stock" id="edit-stock" min="1" required>
                </div>
                <div class="form-group">
                    <label for="edit-precio">Precio</label>
                    <input type="number" name="precio" id="edit-precio" step="0.01" required>
                </div>
            </div>
            <div class="form-group">
                <label for="edit-foto">Nueva imagen (opcional)</label>
                <input type="file" name="foto" id="edit-foto" accept="image/*">
            </div>
            <div class="form-group">
                <label for="edit-categoria">Categor√≠a</label>
                <select name="id_categoria" id="edit-categoria" required>
                    {% for cat in categorias %}
                        <option value="{{ cat.id_categoria }}">{{ cat.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="text-align:right;">
                <button type="button" class="btn" onclick="cerrarModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary guardar-btn">Guardar Producto</button>
            </div>
        </form>
    </div>
</div>

<div id="chatModalOverlay" class="chat-modal-overlay">
    <div class="chat-modal-content">
        <div class="chat-header">
            Asistente UniMarket 
            <button id="closeChatBtn" aria-label="Cerrar chat">&times;</button>
        </div>
        <div class="chat-body" id="chatBody"></div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Escribe tu mensaje..." aria-label="Campo de mensaje">
            <button id="sendChatBtn">Enviar</button>
        </div>
    </div>
</div>

<script>
let chatHistory = [];
const initialBotMessage = "¬°Hola! Soy UniBot, tu asistente para el dashboard de vendedor ü§ñ. Puedo ayudarte a gestionar tus productos, procesar pedidos y revisar tu historial de ventas. ¬øEn qu√© necesitas ayuda hoy?";

// Referencias del Chat
const botBtn = document.getElementById('botBtn');
const chatModalOverlay = document.getElementById('chatModalOverlay');
const closeChatBtn = document.getElementById('closeChatBtn');
const chatBody = document.getElementById('chatBody');
const chatInput = document.getElementById('chatInput');
const sendChatBtn = document.getElementById('sendChatBtn');

// Inicializar el chat
function initializeChat() {
    if (chatBody.children.length === 0) {
        appendMessage(initialBotMessage, 'bot');
    }
}

// Funci√≥n para mostrar mensajes
function appendMessage(text, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message', `${sender}-message`);
    messageDiv.innerHTML = text.replace(/\n/g, '<br>');
    chatBody.appendChild(messageDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
}

// Funci√≥n para mostrar "escribiendo..."
function showTyping() {
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typingIndicator';
    typingDiv.classList.add('message', 'bot-message');
    typingDiv.textContent = 'Escribiendo...';
    chatBody.appendChild(typingDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
}

// Funci√≥n para remover "escribiendo..."
function removeTyping() {
    const typing = document.getElementById('typingIndicator');
    if (typing) typing.remove();
}

// Funci√≥n principal para llamar a la API
async function getBotResponse(userMessage) {
    const CHAT_API_URL = "/api/chat_vendedor";
    
    // Mostrar indicador de escritura
    showTyping();
    
    try {
        const response = await fetch(CHAT_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: userMessage,  // Enviar el mensaje directamente
                history: chatHistory   // Enviar historial
            })
        });

        removeTyping();

        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }

        const data = await response.json();
        const botReply = data.reply || "No pude generar una respuesta. Intenta con otra pregunta.";
        
        // Agregar al historial
        chatHistory.push({ 
            role: 'user', 
            parts: [{ text: userMessage }] 
        });
        chatHistory.push({ 
            role: 'model', 
            parts: [{ text: botReply }] 
        });
        
        appendMessage(botReply, 'bot');

    } catch (error) {
        removeTyping();
        console.error("Error en la llamada a la API:", error);
        appendMessage(`‚ö†Ô∏è Error: No se pudo conectar con el asistente.`, 'bot');
    }
}

// Manejador de env√≠o de mensaje
function sendMessageHandler() {
    const message = chatInput.value.trim();
    if (message === "") return;

    appendMessage(message, 'user');
    chatInput.value = '';
    
    getBotResponse(message);
}

// Eventos del chat
sendChatBtn.addEventListener('click', sendMessageHandler);
chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessageHandler();
});

// Abrir/Cerrar Chat
botBtn.addEventListener('click', () => {
    chatModalOverlay.style.display = 'flex';
    initializeChat();
});

closeChatBtn.addEventListener('click', () => {
    chatModalOverlay.style.display = 'none';
});

chatModalOverlay.addEventListener('click', (e) => {
    if (e.target === chatModalOverlay) {
        chatModalOverlay.style.display = 'none';
    }
});

// Inicializar cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', () => {
    // Asegurarse de que el chat body est√© limpio
    if (chatBody) {
        chatBody.innerHTML = '';
    }
});
    // ‚ö†Ô∏è ATENCI√ìN: La siguiente l√≠nea debe ser eliminada del HTML:
    // <div class="message bot-message">¬°Hola! Soy tu asistente para el dashboard de vendedor. [...]</div>
    // Ya que ahora se inicializa v√≠a JavaScript.

    // ----------------------------------------------------
    // --- Funciones de Gesti√≥n del Dashboard (sin cambios) ---
    // ----------------------------------------------------
    
    function showSection(sectionId, btn) {
        document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
        document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
    }

    function editarProducto(id) {
        if(!id) return alert("ID de producto inv√°lido");
        fetch(`/producto/${id}`)
            .then(res => res.json())
            .then(p => {
                if(!p || !p.id_producto) return alert("No se pudo cargar el producto");
                document.getElementById('edit-id').value = p.id_producto;
                document.getElementById('edit-nombre').value = p.nombre;
                document.getElementById('edit-descripcion').value = p.descripcion;
                document.getElementById('edit-stock').value = p.stock;
                document.getElementById('edit-precio').value = p.precio;
                document.getElementById('edit-categoria').value = p.id_categoria;
                document.getElementById('editModal').style.display = 'flex';
            })
            .catch(err => {
                console.error(err);
                alert("Error al obtener el producto");
            });
    }

    function cerrarModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    document.getElementById('editForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const id = document.getElementById('edit-id').value;
        if(!id) return alert("ID de producto inv√°lido");

        const formData = new FormData(this);

        fetch(`/vendedor/producto/editar/${id}`, {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                alert('Producto actualizado correctamente');
                location.reload();
            } else {
                alert('Error al actualizar: ' + (data.error || ''));
            }
        })
        .catch(err => {
            console.error(err);
            alert("Error al actualizar el producto. Revisa la consola.");
        });
    });

    function eliminarProducto(id) {
        if(confirm("¬øEst√°s seguro de eliminar este producto?")) {
            fetch(`/producto/eliminar/${id}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        document.getElementById(`producto-${id}`).remove();
                    } else {
                        alert("Error al eliminar el producto");
                    }
                });
        }
    }

   function marcarPedidoEntregado(id) {
    if (!confirm("Marcar este pedido como entregado?")) return;

    fetch(`/pedido/entregado/${id}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const pedidoElem = document.getElementById(`pedido-${id}`);
                if (pedidoElem) pedidoElem.remove();

                const historial = document.querySelector('#order-history .product-list');
                const pedidoHist = document.createElement('div');
                pedidoHist.classList.add('product-item');

                let productosHtml = data.pedido.productos.join(', ');

                pedidoHist.innerHTML = `
                    <div class="product-details">
                        <h3>Pedido #${data.pedido.id_pedido}</h3>
                        <p><strong>Comprador:</strong> ${data.pedido.comprador_nombre} (${data.pedido.comprador_correo})</p>
                        <p><strong>Tel√©fono:</strong> ${data.pedido.comprador_telefono || 'No disponible'}</p>
                        <p><strong>Fecha:</strong> ${data.pedido.fecha}</p>
                        <p><strong>Productos:</strong> ${productosHtml}</p>
                        <p><strong>Total:</strong> $${parseFloat(data.pedido.total).toFixed(2)}</p>
                        <span class="order-status completed">Entregado</span>
                    </div>
                `;

                historial.prepend(pedidoHist);

                showSection('order-history');
            } else {
                alert("Error: " + (data.error || "No se pudo marcar como entregado"));
            }
        })
        .catch(err => {
            console.error(err);
            alert("Error al actualizar el pedido. Revisa la consola.");
        });
}


</script>

</body>
</html>