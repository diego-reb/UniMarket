<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Administrador â€“ UniMarket</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css')}}">
<script src="{{ url_for('static', filename='js/accesibilidad.js')}}"></script>
<style>
:root {
Â  Â  --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
Â  Â  --brand:#22c55e; --brand-2:#38bdf8; --accent:#fde047;
Â  Â  --error:#ef4444; --ok:#10b981; --shadow:0 10px 30px rgba(0,0,0,.35);
Â  Â  --radius:12px;
}
* { box-sizing:border-box; }
html,body { height:100%; margin:0; font-family:'Inter',sans-serif; color:var(--text); background:var(--bg);}
.dashboard-container { display:flex; height:100%; padding:20px; gap:20px; }
.sidebar { flex:0 0 250px; background:rgba(2,6,23,.55); border:1px solid rgba(148,163,184,.2); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; display:flex; flex-direction:column; gap:10px; }
.sidebar-logo { display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px; margin-bottom:20px; padding:10px; }
.sidebar-logo-badge { width:32px; height:32px; border-radius:8px; background:linear-gradient(135deg,var(--brand),var(--brand-2)); display:grid; place-items:center; }
.sidebar-logo-badge svg { width:16px; height:16px; }
.sidebar-nav a { display:block; padding:12px; border-radius:8px; color:var(--text); text-decoration:none; transition:background-color .2s; }
.sidebar-nav a:hover, .sidebar-nav a.active { background-color: rgba(56,189,248,.1); }
.main-content { flex:1; background:rgba(2,6,23,.55); border:1px solid rgba(148,163,184,.20); border-radius:var(--radius); box-shadow:var(--shadow); padding:30px; display:flex; flex-direction:column;Â  overflow-y: auto;}
.main-content h1 { margin:0 0 20px; font-size:2rem; text-align:center; color:var(--text); }
.content-section { display:none; }
.content-section.active { display:block; }
.user-list, .product-list { display:grid; gap:20px; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
.user-card, .product-card { background:var(--card); border-radius:var(--radius); padding:20px; display:flex; flex-direction:column; border:1px solid rgba(148,163,184,.20); transition:transform .2s ease; }
.user-card:hover, .product-card:hover { transform: translateY(-5px); box-shadow:0 5px 20px rgba(0,0,0,.2); }
.user-card h3, .product-card h3 { margin:0 0 5px; color:var(--brand); font-size:1.2rem; }
.user-card p, .product-card p { margin:0; font-size:.9rem; color:var(--muted); }
.user-card p strong, .product-card p strong { color:var(--text); }
.user-actions, .product-actions { margin-top:15px; display:flex; gap:10px; }
.edit-btn {
Â  Â  background:var(--brand-2);
Â  Â  padding:10px 18px;
Â  Â  color:white;
Â  Â  border:none;
Â  Â  border-radius:8px;
Â  Â  font-size:.95rem;
Â  Â  cursor:pointer;
}
.edit-btn:hover { transform:scale(1.05); }

.delete-btn {
Â  Â  background:var(--error);
Â  Â  padding:10px 18px;
Â  Â  color:white;
Â  Â  border:none;
Â  Â  border-radius:8px;
Â  Â  font-size:.95rem;
Â  Â  cursor:pointer;
}
.delete-btn:hover { transform:scale(1.05); }
.message-box { padding:15px; border-radius:8px; margin-bottom:20px; text-align:center; display:none; }
.message-box.success { background-color:var(--ok); color:white; }
.message-box.error { background-color:var(--error); color:white; }
.edit-form-container {
Â  Â  display:none;
Â  Â  position:fixed;
Â  Â  top:50%;
Â  Â  left:50%;
Â  Â  transform:translate(-50%, -50%);
Â  Â  z-index:1000;
Â  Â  width:450px;
Â  Â  background:rgba(15,23,42,0.97);
Â  Â  border:1px solid rgba(148,163,184,.25);
Â  Â  box-shadow:0 20px 40px rgba(0,0,0,.55);
Â  Â  border-radius:16px;
Â  Â  padding:25px 30px;
Â  Â  animation:fadeIn .25s ease;
}
.edit-form-container h3 {
Â  Â  text-align:center;
Â  Â  margin-bottom:20px;
Â  Â  font-size:1.4rem;
Â  Â  color:var(--brand-2);
}
.edit-form-container label {
Â  Â  display:block;
Â  Â  margin-bottom:5px;
Â  Â  font-weight:600;
Â  Â  color:var(--text);
}
.edit-form-container input,
.edit-form-container select,
.edit-form-container textarea {
Â  Â  width:100%;
Â  Â  padding:10px 12px;
Â  Â  background:#0f172a;
Â  Â  border:1px solid rgba(148,163,184,.25);
Â  Â  border-radius:8px;
Â  Â  color:var(--text);
Â  Â  margin-bottom:15px;
Â  Â  font-size:.95rem;
}

.edit-form-container textarea {
Â  Â  resize:none;
}

.modal-buttons {
Â  Â  display:flex;
Â  Â  justify-content:flex-end;
Â  Â  gap:10px;
Â  Â  margin-top:15px;
}

.modal-overlay {
Â  Â  backdrop-filter: blur(4px);
}
.filter-buttons { display:flex; justify-content:center; gap:10px; margin-bottom:20px; }
.filter-buttons button { background:var(--card); border:1px solid rgba(148,163,184,.20); color:var(--text); padding:8px 16px; border-radius:6px; cursor:pointer; }
.filter-buttons button.active { background-color:var(--brand-2); color:white; }
@media (max-width:768px) { .dashboard-container { flex-direction:column; padding:10px; } .sidebar { flex:none; width:100%; } .main-content { padding:20px; } }
@keyframes fadeIn {
Â  Â  from { opacity:0; transform:translate(-50%, -48%); }
Â  Â  toÂ  Â { opacity:1; transform:translate(-50%, -50%); }
}

/* Estilos para el Modal del Chatbot (Copiado de index.html) */
.chat-modal-overlay {
Â  Â  position: fixed;
Â  Â  top: 0; left: 0; right: 0; bottom: 0;
Â  Â  background: rgba(0, 0, 0, 0.6);
Â  Â  display: none; /* Inicialmente oculto */
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  z-index: 1000;
}

.chat-modal-content {
Â  Â  background: var(--card);
Â  Â  border-radius: var(--radius);
Â  Â  width: 350px;
Â  Â  height: 450px;
Â  Â  box-shadow: var(--shadow);
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  overflow: hidden;
}

.chat-header {
Â  Â  background: linear-gradient(90deg, var(--brand), var(--brand-2));
Â  Â  padding: 15px;
Â  Â  color: var(--bg);
Â  Â  font-weight: bold;
Â  Â  display: flex;
Â  Â  justify-content: space-between;
Â  Â  align-items: center;
}

.chat-header button {
Â  Â  background: none;
Â  Â  border: none;
Â  Â  color: var(--bg);
Â  Â  font-size: 1.5rem;
Â  Â  cursor: pointer;
Â  Â  line-height: 1;
}

.chat-body {
Â  Â  flex-grow: 1;
Â  Â  padding: 15px;
Â  Â  overflow-y: auto;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  gap: 10px;
}

.chat-input-area {
Â  Â  padding: 10px 15px;
Â  Â  border-top: 1px solid rgba(148, 163, 184, 0.1);
Â  Â  display: flex;
Â  Â  gap: 10px;
}

.chat-input-area input {
Â  Â  flex-grow: 1;
Â  Â  padding: 10px;
Â  Â  border-radius: 999px;
Â  Â  border: 1px solid var(--muted);
Â  Â  background: var(--bg);
Â  Â  color: var(--text);
Â  Â  outline: none;
}

.chat-input-area button {
Â  Â  background: var(--brand);
Â  Â  color: var(--bg);
Â  Â  border: none;
Â  Â  border-radius: 999px;
Â  Â  padding: 10px 15px;
Â  Â  cursor: pointer;
Â  Â  transition: background-color 0.2s;
}

.chat-input-area button:hover {
Â  Â  background: var(--ok);
}

/* Estilos de mensajes */
.message {
Â  Â  max-width: 80%;
Â  Â  padding: 8px 12px;
Â  Â  border-radius: 12px;
}

.user-message {
Â  Â  align-self: flex-end;
Â  Â  background-color: var(--brand-2); /* Sky Blue */
Â  Â  color: var(--bg);
}

.bot-message {
Â  Â  align-self: flex-start;
Â  Â  background-color: var(--card);
Â  Â  border: 1px solid rgba(148, 163, 184, 0.15);
}

.bot-message::before {
Â  Â  content: 'ğŸ¤– ';
}

.icon-btn {
Â  Â  width:42px; height:42px; border-radius:8px; display:grid; place-items:center; border:1px solid rgba(148,163,184,.25);
Â  Â  background:rgba(2,6,23,.6); cursor:pointer; transition:transform .06s ease, border .2s;
Â  Â  /* Ajuste para que se vea bien en la barra de filtros */
Â  Â  padding: 8px 16px;
Â  Â  font-size: 0.95rem;
Â  Â  color: var(--text);
Â  Â  background: var(--card);
}
.icon-btn:hover { border-color:var(--brand-2); }
.icon-btn:active { transform:translateY(1px); }

.crear-btn {
Â  Â  background:var(--brand);
Â  Â  padding:10px 18px;
Â  Â  color:var(--bg);
Â  Â  border:none;
Â  Â  border-radius:8px;
Â  Â  font-size:.95rem;
Â  Â  cursor:pointer;
}

</style>
</head>
<body>
Â  Â  <div class="reading-guide" id="reading-guide-mask"></div>
<div class="dashboard-container">
Â  Â  <div class="sidebar">
Â  Â  Â  Â  <div class="sidebar-logo">
Â  Â  Â  Â  Â  Â  <div class="sidebar-logo-badge" aria-hidden="true">
Â  Â  Â  Â  Â  Â  Â  Â  <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M7 8V7a5 5 0 0 1 10 0v1" stroke="#0b1020" stroke-width="2" stroke-linecap="round"/><rect x="4" y="8" width="16" height="12" rx="3" fill="rgba(255,255,255,.90)"/><path d="M7 13h10" stroke="#0b1020" stroke-width="2" stroke-linecap="round"/><circle cx="10" cy="19" r="1.6" fill="#0b1020"/><circle cx="16" cy="19" r="1.6" fill="#0b1020"/></svg>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  UniMarket
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <nav class="sidebar-nav">
Â  Â  Â  Â  Â  Â  <a href="#" id="nav-users" class="active">Usuarios</a>
Â  Â  Â  Â  Â  Â  <a href="#" id="nav-products">Productos</a>
Â  Â  Â  Â  Â  Â  <a href="{{ url_for('logout') }}" style="margin-top:auto; color:var(--error); font-weight:bold;">Cerrar sesiÃ³n</a>
Â  Â  Â  Â  </nav>
Â  Â  </div>

Â  Â  <div class="main-content">
Â  Â  Â  Â  <h1>Bienvenid@ de nuevo {{current_user.nombre}}</h1>
Â  Â  Â  Â  <div id="message-box" class="message-box"></div>

Â  Â  Â  Â  <div id="users-section" class="content-section active">
Â  Â  Â  Â  Â  Â  <div class="filter-buttons">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="filter-btn active" data-filter="all">Todos</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="filter-btn" data-filter="vendedor">Vendedores</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="filter-btn" data-filter="comprador">Compradores</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="filter-btn" data-filter="administrador">Administrador</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="icon-btn" id="botBtn" title="Asistente UniMarket" aria-label="Abrir Asistente de Chat" style="margin-left:auto; margin-right:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M12 18H8a4 4 0 0 1 0-8h4a4 4 0 1 0 0-8H8" stroke="#38bdf8" stroke-width="2" stroke-linecap="round"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M16 12a4 4 0 0 0-4-4h-4a4 4 0 1 0 0 8h4a4 4 0 1 0 0-8" stroke="#38bdf8" stroke-width="2" stroke-linecap="round"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <circle cx="12" cy="12" r="10" stroke="#94a3b8" stroke-width="2"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Chatbot
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="crear-btn" onclick="abrirModal('crear-usuario-modal')">Crear Usuario</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="user-list" class="user-list">
Â  Â  Â  Â  Â  Â  Â  Â  {% for u in usuarios %}
Â  Â  Â  Â  Â  Â  Â  Â  <div class="user-card" data-role="{{ u.rol.nombre|lower }}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>{{ u.nombre }}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Rol:</strong> {{ u.rol.nombre if u.rol else 'Sin rol' }}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Correo:</strong> {{ u.correo }}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Telefono:</strong> {{ u.telefono }}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="user-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="edit-btn"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onclick="abrirEditarUsuario({{ u.id_usuario }}, '{{ u.nombre }}', '{{ u.correo }}', '{{ u.telefono }}', {{ u.id_rol }}, '{{ 'True' if u.estado else 'False' }}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Editar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form method="POST" action="{{ url_for('eliminar_usuario', id=u.id_usuario) }}" style="display:inline;" onsubmit="return confirm('Â¿Seguro que quieres eliminar a {{ u.nombre }}?');">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {% if csrf_token is defined %}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {% endif %}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="delete-btn">Eliminar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  {% else %}
Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align:center; color:var(--muted);">No hay usuarios registrados.</p>
Â  Â  Â  Â  Â  Â  Â  Â  {% endfor %}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="products-section" class="content-section">
Â  Â  Â  Â  Â  Â  <div class="filter-buttons">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="filter-btn active" data-filter="all">Todos</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="filter-btn" data-filter="published">Publicados</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="filter-btn" data-filter="pending">Pendientes</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="crear-btn" style="margin-left:auto;" onclick="abrirModal('crear-producto-form')">Agregar Producto</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="product-list" class="product-list">
Â  Â  Â  Â  Â  Â  Â  Â  {% for p in productos %}
Â  Â  Â  Â  Â  Â  Â  Â  <div class="product-card" data-id="{{ p.id_producto }}" data-categoria="{{ p.id_categoria }}" data-status="{{ 'published' if p.estado else 'pending' }}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>{{ p.nombre }}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>DescripciÃ³n:</strong> {{ p.descripcion }}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Precio:</strong> ${{ '%.2f'|format(p.precio) }}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Stock:</strong> {{ p.stock }}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Vendedor:</strong> {{ p.vendedor.nombre }}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Estado:</strong> {{ 'Publicado' if p.estado else 'Pendiente' }}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {% if p.foto %}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="{{ url_for('static', filename='uploads/' ~ p.foto) }}" alt="{{ p.nombre }}" style="max-width:100%; border-radius:8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {% endif %}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="product-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="edit-btn" onclick="abrirEditarProducto({{ p.id_producto }}, '{{ p.nombre }}', '{{ p.descripcion }}', {{ p.stock }}, {{ p.precio }}, {{ p.id_vendedor }}, {{ p.id_categoria }})">Editar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form method="POST" action="{{ url_for('eliminar_producto', id=p.id_producto) }}" style="display:inline;" onsubmit="return confirm('Â¿Seguro que quieres eliminar el producto \"{{ p.nombre }}\"?');">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {% if csrf_token is defined %}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {% endif %}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="delete-btn">Eliminar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  {% else %}
Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align:center; color:var(--muted);">No hay productos.</p>
Â  Â  Â  Â  Â  Â  Â  Â  {% endfor %}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="modal-overlay" class="modal-overlay" onclick="cerrarModal()"></div>

<div id="crear-usuario-modal" class="edit-form-container">
Â  Â  <h3>Crear Nuevo Usuario</h3>

Â  Â  <form method="POST" action="{{ url_for('crear_usuario') }}">
Â  Â  Â  Â  {% if csrf_token is defined %}
Â  Â  Â  Â  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
Â  Â  Â  Â  {% endif %}

Â  Â  Â  Â  <label>Nombre:</label>
Â  Â  Â  Â  <input type="text" name="nombre" required>

Â  Â  Â  Â  <label>Correo:</label>
Â  Â  Â  Â  <input type="email" name="correo" required>

Â  Â  Â  Â  <label>ContraseÃ±a:</label>
Â  Â  Â  Â  <input type="password" name="password">

Â  Â  Â  Â  <label>Confirmar contraseÃ±a:</label>
Â  Â  Â  Â  <input type="password" name="confirmar">

Â  Â  Â  Â  <label>TelÃ©fono:</label>
Â  Â  Â  Â  <input type="text" name="telefono">

Â  Â  Â  Â  <label>Rol:</label>
Â  Â  Â  Â  <select name="id_rol" required>
Â  Â  Â  Â  Â  Â  {% for r in rol %}
Â  Â  Â  Â  Â  Â  <option value="{{ r.id_rol }}">{{ r.nombre }}</option>
Â  Â  Â  Â  Â  Â  {% endfor %}
Â  Â  Â  Â  </select>

Â  Â  Â  Â  <label>Estado:</label>
Â  Â  Â  Â  <select name="estado" required>
Â  Â  Â  Â  Â  Â  <option value="True">Activo</option>
Â  Â  Â  Â  Â  Â  <option value="False">Inactivo</option>
Â  Â  Â  Â  </select>

Â  Â  Â  Â  <div class="modal-buttons">
Â  Â  Â  Â  Â  Â  <button type="button" class="delete-btn" onclick="cerrarModal()">Cancelar</button>
Â  Â  Â  Â  Â  Â  <button type="submit" class="edit-btn">Crear Usuario</button>
Â  Â  Â  Â  </div>
Â  Â  </form>
</div>
<div id="editar-usuario-modal" class="edit-form-container">
Â  Â  <h3>Editar Usuario</h3>

Â  Â  <form id="editar-usuario-form" method="POST">
Â  Â  Â  Â  {% if csrf_token is defined %}
Â  Â  Â  Â  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
Â  Â  Â  Â  {% endif %}

Â  Â  Â  Â  <label>Nombre:</label>
Â  Â  Â  Â  <input type="text" name="nombre" id="editar-nombre" required>

Â  Â  Â  Â  <label>Correo:</label>
Â  Â  Â  Â  <input type="email" name="correo" id="editar-correo" required>

Â  Â  Â  Â  <label>TelÃ©fono:</label>
Â  Â  Â  Â  <input type="text" name="telefono" id="editar-telefono">

Â  Â  Â  Â  <label>ContraseÃ±a:</label>
Â  Â  Â  Â  <input type="password" name="password" id="editar-password" placeholder="DÃ©jala en blanco si no deseas cambiarla">

Â  Â  Â  Â  <label>Confirmar ContraseÃ±a:</label>
Â  Â  Â  Â  <input type="password" name="confirmar" id="editar-confirmar" placeholder="DÃ©jala en blanco si no deseas cambiarla">

Â  Â  Â  Â  <label>Rol:</label>
Â  Â  Â  Â  <select name="id_rol" id="editar-rol" required>
Â  Â  Â  Â  Â  Â  {% for r in rol %}
Â  Â  Â  Â  Â  Â  <option value="{{ r.id_rol }}">{{ r.nombre }}</option>
Â  Â  Â  Â  Â  Â  {% endfor %}
Â  Â  Â  Â  </select>

Â  Â  Â  Â  <label>Estado:</label>
Â  Â  Â  Â  <select name="estado" id="editar-estado" required>
Â  Â  Â  Â  Â  Â  <option value="True">Activo</option>
Â  Â  Â  Â  Â  Â  <option value="False">Inactivo</option>
Â  Â  Â  Â  </select>

Â  Â  Â  Â  <div class="modal-buttons">
Â  Â  Â  Â  Â  Â  <button type="button" class="delete-btn" onclick="cerrarModal()">Cancelar</button>
Â  Â  Â  Â  Â  Â  <button type="submit" class="edit-btn">Guardar cambios</button>
Â  Â  Â  Â  </div>
Â  Â  </form>
</div>

<div id="crear-producto-form" class="edit-form-container">
Â  Â  <h3>Agregar Nuevo Producto</h3>

Â  Â  <form method="POST" action="{{ url_for('crear_producto_post') }}" enctype="multipart/form-data">
Â  Â  Â  Â  {% if csrf_token is defined %}
Â  Â  Â  Â  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
Â  Â  Â  Â  {% endif %}

Â  Â  Â  Â  <label>Nombre:</label>
Â  Â  Â  Â  <input type="text" name="nombre" required>

Â  Â  Â  Â  <label>DescripciÃ³n:</label>
Â  Â  Â  Â  <textarea name="descripcion" rows="4" required></textarea>

Â  Â  Â  Â  <label>Cantidad:</label>
Â  Â  Â  Â  <input type="number" name="stock" min="1" required>

Â  Â  Â  Â  <label>Precio ($):</label>
Â  Â  Â  Â  <input type="number" name="precio" min="0" step="0.01" required>

Â  Â  Â  Â  <label>Foto:</label>
Â  Â  Â  Â  <input type="file" name="foto" accept="image/*">

Â  Â  Â  Â  <label>Vendedor:</label>
Â  Â  Â  Â  <select name="id_vendedor" required>
Â  Â  Â  Â  Â  Â  {% for v in vendedores %}
Â  Â  Â  Â  Â  Â  <option value="{{ v.id_usuario }}">{{ v.nombre }}</option>
Â  Â  Â  Â  Â  Â  {% endfor %}
Â  Â  Â  Â  </select>

Â  Â  Â  Â  <label>CategorÃ­a:</label>
Â  Â  Â  Â  <select name="id_categoria" required>
Â  Â  Â  Â  Â  Â  {% for c in categorias %}
Â  Â  Â  Â  Â  Â  <option value="{{ c.id_categoria }}">{{ c.nombre }}</option>
Â  Â  Â  Â  Â  Â  {% endfor %}
Â  Â  Â  Â  </select>

Â  Â  Â  Â  <div class="modal-buttons">
Â  Â  Â  Â  Â  Â  <button type="button" class="delete-btn" onclick="cerrarModal()">Cancelar</button>
Â  Â  Â  Â  Â  Â  <button type="submit" class="edit-btn">Agregar Producto</button>
Â  Â  Â  Â  </div>
Â  Â  </form>
</div>

<div id="editar-producto-form" class="edit-form-container">
Â  Â  <h3>Editar Producto</h3>

Â  Â  <form id="form-editar-producto" method="POST" enctype="multipart/form-data">
Â  Â  Â  Â  {% if csrf_token is defined %}
Â  Â  Â  Â  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
Â  Â  Â  Â  {% endif %}

Â  Â  Â  Â  <label>Nombre:</label>
Â  Â  Â  Â  <input type="text" name="nombre" id="edit-prod-nombre" required>

Â  Â  Â  Â  <label>DescripciÃ³n:</label>
Â  Â  Â  Â  <textarea name="descripcion" rows="4" id="edit-prod-descripcion" required></textarea>

Â  Â  Â  Â  <label>Cantidad:</label>
Â  Â  Â  Â  <input type="number" name="stock" min="1" id="edit-prod-stock" required>

Â  Â  Â  Â  <label>Precio ($):</label>
Â  Â  Â  Â  <input type="number" name="precio" min="0" step="0.01" id="edit-prod-precio" required>

Â  Â  Â  Â  <label>Nueva Foto (opcional):</label>
Â  Â  Â  Â  <input type="file" name="foto" accept="image/*">

Â  Â  Â  Â  <label>Vendedor:</label>
Â  Â  Â  Â  <select name="id_vendedor" id="edit-prod-vendedor" required>
Â  Â  Â  Â  Â  Â  {% for v in vendedores %}
Â  Â  Â  Â  Â  Â  <option value="{{ v.id_usuario }}">{{ v.nombre }}</option>
Â  Â  Â  Â  Â  Â  {% endfor %}
Â  Â  Â  Â  </select>

Â  Â  Â  Â  <label>CategorÃ­a:</label>
Â  Â  Â  Â  <select name="id_categoria" id="edit-prod-categoria" required>
Â  Â  Â  Â  Â  Â  {% for c in categorias %}
Â  Â  Â  Â  Â  Â  <option value="{{ c.id_categoria }}">{{ c.nombre }}</option>
Â  Â  Â  Â  Â  Â  {% endfor %}
Â  Â  Â  Â  </select>

Â  Â  Â  Â  <div class="modal-buttons">
Â  Â  Â  Â  Â  Â  <button type="button" class="delete-btn" onclick="cerrarModal()">Cancelar</button>
Â  Â  Â  Â  Â  Â  <button type="submit" class="edit-btn">Guardar Cambios</button>
Â  Â  Â  Â  </div>
Â  Â  </form>
</div>


<div id="chatModalOverlay" class="chat-modal-overlay">
Â  Â  <div class="chat-modal-content">
Â  Â  Â  Â  <div class="chat-header">
Â  Â  Â  Â  Â  Â  Asistente UniMarketÂ 
Â  Â  Â  Â  Â  Â  <button id="closeChatBtn" aria-label="Cerrar chat">&times;</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="chat-body" id="chatBody">
Â  Â  Â  Â  Â  Â  <div class="message bot-message">Â¡Hola! Soy tu asistente. PregÃºntame sobre el funcionamiento de UniMarket.</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="chat-input-area">
Â  Â  Â  Â  Â  Â  <input type="text" id="chatInput" placeholder="Escribe tu mensaje..." aria-label="Campo de mensaje">
Â  Â  Â  Â  Â  Â  <button id="sendChatBtn">Enviar</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<script>
// Filtrado de usuarios por rol
document.addEventListener('DOMContentLoaded', () => {
Â  Â  const filterBtns = document.querySelectorAll('#users-section .filter-btn');
Â  Â  const userCards = document.querySelectorAll('#user-list .user-card');

Â  Â  filterBtns.forEach(btn => {
Â  Â  Â  Â  btn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  // Remover clase active de todos los botones
Â  Â  Â  Â  Â  Â  filterBtns.forEach(b => b.classList.remove('active'));
Â  Â  Â  Â  Â  Â  btn.classList.add('active');

Â  Â  Â  Â  Â  Â  const filter = btn.getAttribute('data-filter');

Â  Â  Â  Â  Â  Â  userCards.forEach(card => {
Â  Â  Â  Â  Â  Â  Â  Â  const role = card.getAttribute('data-role'); // vendedor, comprador, administrador
Â  Â  Â  Â  Â  Â  Â  Â  if (filter === 'all' || role === filter) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  });

Â  Â  // Filtrado de productos por estado
Â  Â  const productFilterBtns = document.querySelectorAll('#products-section .filter-btn');
Â  Â  const productCards = document.querySelectorAll('#product-list .product-card');

Â  Â  productFilterBtns.forEach(btn => {
Â  Â  Â  Â  btn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  productFilterBtns.forEach(b => b.classList.remove('active'));
Â  Â  Â  Â  Â  Â  btn.classList.add('active');

Â  Â  Â  Â  Â  Â  const filter = btn.getAttribute('data-filter');

Â  Â  Â  Â  Â  Â  productCards.forEach(card => {
Â  Â  Â  Â  Â  Â  Â  Â  const status = card.getAttribute('data-status'); // published o pending
Â  Â  Â  Â  Â  Â  Â  Â  if (filter === 'all' || status === filter) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  });
});
</script>

<script>
function abrirModal(id){
Â  Â  document.getElementById(id).style.display='block';
Â  Â  document.getElementById('modal-overlay').style.display='block';
}
function cerrarModal(){
Â  Â  document.querySelectorAll('.edit-form-container').forEach(m => m.style.display='none');
Â  Â  document.getElementById('modal-overlay').style.display='none';
Â  Â  // AdemÃ¡s, cerrar el modal del chatbot si estÃ¡ abierto
Â  Â  document.getElementById('chatModalOverlay').style.display='none';
}

// Editar usuario
function abrirEditarUsuario(id, nombre, correo, telefono, rol, estado){
Â  Â  abrirModal('editar-usuario-modal');
Â  Â  const form = document.getElementById('editar-usuario-form');
Â  Â  form.action = `/usuario/editar/${id}`;
Â  Â  document.getElementById('editar-nombre').value = nombre;
Â  Â  document.getElementById('editar-correo').value = correo;
Â  Â  document.getElementById('editar-telefono').value = telefono;
Â  Â  document.getElementById('editar-rol').value = rol;
Â  Â  document.getElementById('editar-estado').value = estado;
}

// Editar producto
function abrirEditarProducto(id,nombre,descripcion,stock,precio,vendedor,categoria){
Â  Â  // Usa el modal dedicado a editar productos para no interferir con crear_producto_form
Â  Â  abrirModal('editar-producto-form');
Â  Â  const form = document.getElementById('form-editar-producto');
Â  Â  form.action=`/producto/editar/${id}`;
Â  Â  document.getElementById('edit-prod-nombre').value = nombre;
Â  Â  document.getElementById('edit-prod-descripcion').value = descripcion;
Â  Â  document.getElementById('edit-prod-stock').value = stock;
Â  Â  document.getElementById('edit-prod-precio').value = precio;
Â  Â  document.getElementById('edit-prod-vendedor').value = vendedor;
Â  Â  document.getElementById('edit-prod-categoria').value = categoria;
}

// NavegaciÃ³n secciones
document.addEventListener('DOMContentLoaded',()=>{
Â  Â  const navUsers=document.getElementById('nav-users');
Â  Â  const navProducts=document.getElementById('nav-products');
Â  Â  function showSection(id){
Â  Â  Â  Â  document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
Â  Â  Â  Â  document.getElementById(id).classList.add('active');
Â  Â  Â  Â  document.querySelectorAll('.sidebar-nav a').forEach(a=>a.classList.remove('active'));
Â  Â  Â  Â  if(id==='users-section') navUsers.classList.add('active'); else navProducts.classList.add('active');
Â  Â  }
Â  Â  navUsers.addEventListener('click',e=>{e.preventDefault(); showSection('users-section');});
Â  Â  navProducts.addEventListener('click',e=>{e.preventDefault(); showSection('products-section');});
});

// --- Funcionalidad del Chatbot (Actualizado con clave funcional) ---

// ğŸ”‘ CLAVE API DE GEMINI INSERTADA AQUÃ
const GEMINI_API_KEY = "AIzaSyAoHCyL8KFca7Vr3sFB2m0kbeI8Nd6tqmE";Â 
const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";

// --- Referencias del Chat ---
const botBtn = document.getElementById('botBtn');
const chatModalOverlay = document.getElementById('chatModalOverlay');
const closeChatBtn = document.getElementById('closeChatBtn');
const chatBody = document.getElementById('chatBody');
const chatInput = document.getElementById('chatInput');
const sendChatBtn = document.getElementById('sendChatBtn');

// --- Funcionalidad del Chatbot ---

// FunciÃ³n para mostrar mensajes en el chat
function appendMessage(text, sender) {
Â  Â  const messageDiv = document.createElement('div');
Â  Â  messageDiv.classList.add('message', `${sender}-message`);
Â  Â  // Permite saltos de lÃ­nea y formateo bÃ¡sico si la API lo devuelve
Â  Â  messageDiv.innerHTML = text.replace(/\n/g, '<br>');Â 
Â  Â  chatBody.appendChild(messageDiv);
Â  Â  // Desplazar hacia el Ãºltimo mensaje
Â  Â  chatBody.scrollTop = chatBody.scrollHeight;
}

// FunciÃ³n principal para llamar a la API
async function getBotResponse(userMessage) {
Â  Â  if (!GEMINI_API_KEY) {
Â  Â  Â  Â  appendMessage("âŒ Error: La clave API de Gemini no estÃ¡ configurada.", 'bot');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  try {
Â  Â  Â  Â  // Agregar mensaje de carga
Â  Â  Â  Â  const loadingMessage = document.createElement('div');
Â  Â  Â  Â  loadingMessage.classList.add('message', 'bot-message');
Â  Â  Â  Â  loadingMessage.textContent = "ğŸ¤– Escribiendo...";
Â  Â  Â  Â  chatBody.appendChild(loadingMessage);
Â  Â  Â  Â  chatBody.scrollTop = chatBody.scrollHeight;

Â  Â  Â  Â  // ConstrucciÃ³n de la URL y la solicitud corregida
Â  Â  Â  Â  const fullUrl = `${GEMINI_API_URL}?key=${GEMINI_API_KEY}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const response = await fetch(fullUrl, {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  Â  Â  contents: [{Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  role: "user",Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  parts: [{ text: `Eres UniBot, el asistente de soporte de inteligencia artificial del portal UniMarket, el mercado exclusivo para la comunidad del ITIZ. Tu rol es ESTRICTO Y LIMITADO: proporcionar informaciÃ³n precisa ÃšNICAMENTE sobre las polÃ­ticas, mecÃ¡nicas, productos y funcionalidades de la plataforma UniMarket. SÃ© amigable, conciso y utiliza los siguientes 'guiones' de respuesta para asegurar la coherencia:

BASE DE CONOCIMIENTO (NARRATIVAS DE RESPUESTA):

A. CreaciÃ³n de Vendedores (Disparadores: "Â¿CÃ³mo puedo crear un nuevo vendedor?, Vendedor, Agregar Vendedor, Vendedores, Usuarios, Comprador, Agregar Comprador"): "Para crear un nuevo usuario vendedor:

Ve a la secciÃ³n 'Usuarios'

Haz clic en 'Crear Usuario'

Completa los datos: nombre, correo, telÃ©fono

Selecciona 'Vendedor/Comprador' en el campo Rol

Establece la contraseÃ±a y confÃ­rmala

Haz clic en 'Crear Usuario'"

B. Filtro de Productos Pendientes (Disparadores: "Necesito ver solo los productos pendientes de aprobaciÃ³n, Productos, Productos pendientes, Pendientes"): "En la secciÃ³n 'Productos', haz clic en el botÃ³n de filtro 'Pendientes' para ver solo los productos que esperan aprobaciÃ³n."

C. Cambio de Rol de Usuario (Disparadores: "Â¿CÃ³mo cambio el rol de un usuario?, Rol, Cambio de rol, Roles"): "Busca al usuario en la secciÃ³n 'Usuarios', haz clic en 'Editar' y en el modal que aparece cambia el campo 'Rol' al deseado ya sea vendedor o comprador, luego guarda los cambios."

REGLA DE RESTRICCIÃ“N ESTRICTA (IMPERATIVA):

Si la pregunta del usuario es sobre un tema que NO estÃ¡ cubierto por estas tres narrativas (A, B, o C) o la BASE DE CONOCIMIENTO (ej: informaciÃ³n acadÃ©mica, noticias, problemas personales, o cualquier otra funciÃ³n que no sea crear vendedores, ver pendientes, o cambiar roles), DEBES RESPONDER EXCLUSIVAMENTE:

"Lo siento, mi funciÃ³n es estrictamente asistirte con preguntas sobre el mercado universitario UniMarket y sus polÃ­ticas de venta/entrega. No tengo informaciÃ³n sobre ese tema."

Pregunta del usuario a responder:${userMessage}` }]
Â  Â  Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  });

Â  Â  Â  Â  // Si la respuesta no es OK (ej: 400, 403, 500)
Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  const errorData = await response.json();
Â  Â  Â  Â  Â  Â  throw new Error(`Error de API (${response.status}): ${errorData.error.message || 'Error desconocido'}`);
Â  Â  Â  Â  }

Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Remover el mensaje de carga
Â  Â  Â  Â  if (chatBody.lastElementChild && chatBody.lastElementChild === loadingMessage) {
Â  Â  Â  Â  Â  Â  chatBody.lastElementChild.remove();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const botReply = data.candidates?.[0]?.content?.parts?.[0]?.text || "No pude generar una respuesta. Intenta con otra pregunta.";
Â  Â  Â  Â  appendMessage(botReply, 'bot');

Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Error en la llamada a la API:", error);
Â  Â  Â  Â  // Remover el mensaje de carga en caso de error
Â  Â  Â  Â  if (chatBody.lastElementChild && chatBody.lastElementChild.textContent === "ğŸ¤– Escribiendo...") {
Â  Â  Â  Â  Â  Â  chatBody.lastElementChild.remove();
Â  Â  Â  Â  }
Â  Â  Â  Â  appendMessage(`Hubo un error: ${error.message}.`, 'bot');
Â  Â  }
}

// Manejador de envÃ­o de mensaje
function sendMessageHandler() {
Â  Â  const message = chatInput.value.trim();
Â  Â  if (message === "") return;

Â  Â  appendMessage(message, 'user');
Â  Â  chatInput.value = '';
Â  Â Â 
Â  Â  getBotResponse(message);
}

// Eventos del chat
sendChatBtn.addEventListener('click', sendMessageHandler);
chatInput.addEventListener('keypress', (e) => {
Â  Â  if (e.key === 'Enter') sendMessageHandler();
});

// Abrir/Cerrar Chat
botBtn.addEventListener('click', () => {
Â  Â  chatModalOverlay.style.display = 'flex';
});

closeChatBtn.addEventListener('click', () => {
Â  Â  chatModalOverlay.style.display = 'none';
});

// Cierre del chat al hacer clic en el fondo oscuro
chatModalOverlay.addEventListener('click', (e) => {
Â  Â  if (e.target === chatModalOverlay) {
Â  Â  Â  Â  chatModalOverlay.style.display = 'none';
Â  Â  }
});

// Nota: Se agregÃ³ un modal de ediciÃ³n de producto dedicado y se actualizÃ³ la funciÃ³n abrirEditarProducto para no interferir con el modal de creaciÃ³n.
</script>
</body>
</html>